<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ve√≠culos de Comunica√ß√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-group { display: inline-block; margin-right: 20px; margin-bottom: 10px; }
        .filter-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .filter-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        .kpis { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi { background: white; padding: 20px; border-radius: 10px; text-align: center; flex: 1; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .kpi h3 { margin: 0; font-size: 2em; }
        .kpi p { margin: 5px 0 0 0; color: #666; }
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        th { background-color: #3498db; color: white; position: sticky; top: 0; z-index: 10; }
        td { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        td:first-child { max-width: 200px; font-weight: bold; } /* Nome do ve√≠culo */
        td:nth-child(7) { max-width: 120px; } /* Endere√ßo */
        td:nth-child(8) { text-align: right; } /* M√©dia Trimestral */
        tr.reprovado { background-color: #ffebee; }
        tr.reprovado td { color: #c62828; font-weight: bold; }
        tr.reprovado:hover { background-color: #ffcdd2; }
        tr:hover { background-color: #f8f9fa; }
        .loading { text-align: center; padding: 50px; }
        .pdf-button { 
            background-color: #e74c3c; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 0; 
            float: right;
        }
        .pdf-button:hover { background-color: #c0392b; }
        .refresh-button { 
            background-color: #27ae60; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 5px; 
        }
        .refresh-button:hover { background-color: #229954; }
        .refresh-button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .header-buttons { display: flex; gap: 10px; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .data-source-indicator {
            background: #ecf0f1;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            border-left: 4px solid #3498db;
        }
        .data-source-indicator.google-sheets { border-left-color: #27ae60; }
        .data-source-indicator.local-file { border-left-color: #f39c12; }
        
        /* Estilos para An√°lise de Desertos de M√≠dia */
        .desertos-section { 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            margin: 30px 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .desertos-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #e74c3c; 
            padding-bottom: 10px; 
        }
        .desertos-header h2 { 
            color: #e74c3c; 
            margin: 0; 
            font-size: 1.8em; 
        }
        .desertos-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .deserto-stat { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a52); 
            color: white; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .deserto-stat.critica { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
        }
        .deserto-stat.adequada { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
        }
        .deserto-stat h4 { 
            margin: 0 0 5px 0; 
            font-size: 2em; 
            font-weight: bold; 
        }
        .deserto-stat p { 
            margin: 0; 
            font-size: 0.9em; 
            opacity: 0.9; 
        }
        .desertos-charts { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .deserto-chart { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            border-left: 4px solid #e74c3c; 
        }
        .deserto-chart h4 { 
            margin: 0 0 15px 0; 
            color: #2c3e50; 
        }
        .municipios-list { 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 0.9em; 
            line-height: 1.4; 
        }
        .municipio-item { 
            padding: 5px 10px; 
            margin: 2px 0; 
            background: white; 
            border-radius: 4px; 
            border-left: 3px solid #e74c3c; 
        }
        .municipio-item.critico { 
            border-left-color: #f39c12; 
        }
        .municipio-item.adequado { 
            border-left-color: #27ae60; 
        }
        .toggle-button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9em; 
            margin-top: 10px; 
        }
        .toggle-button:hover { 
            background: #2980b9; 
        }
        @media (max-width: 768px) {
            .desertos-charts { 
                grid-template-columns: 1fr; 
            }
            .desertos-stats { 
                grid-template-columns: 1fr; 
            }
        }
        @media print {
            .pdf-button { display: none; }
            .filters { page-break-after: always; }
            .charts { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <h1>Dashboard de An√°lise de Ve√≠culos de Comunica√ß√£o</h1>
            <div class="header-buttons">
                <button class="refresh-button" onclick="refreshData()">üîÑ Atualizar Dados</button>
                <button class="pdf-button" onclick="generatePDF()">üìÑ Gerar PDF</button>
            </div>
        </div>
        
        <div class="data-source-indicator" id="data-source">
            <span id="data-source-text">üìÅ Fonte: <a href="https://docs.google.com/spreadsheets/d/17TnGB6NpsziDec4fPH-d0TCQwk2LN0BAv6yjmIpyZnI/edit?gid=1225239898#gid=1225239898" target="_blank" style="color: #f39c12; text-decoration: underline;">Google Sheets</a> (137 registros)</span>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="cidade-filter">Filtrar por Cidade:</label>
                <select id="cidade-filter">
                    <option value="all">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="status-filter">Filtrar por Status:</label>
                <select id="status-filter">
                    <option value="all">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="categoria-filter">Filtrar por Categoria:</label>
                <select id="categoria-filter">
                    <option value="all">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search-input">Buscar por Nome do Site:</label>
                <input type="text" id="search-input" placeholder="Digite o nome do site..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
            </div>
        </div>
        
        <div class="kpis" id="kpis">
            <div class="loading">Carregando dados...</div>
        </div>
        
        <div class="charts">
            <div class="chart">
                <h3>Distribui√ß√£o por Status</h3>
                <canvas id="status-chart" width="400" height="300"></canvas>
            </div>
            <div class="chart">
                <h3>Top 10 Cidades</h3>
                <canvas id="cidade-chart" width="400" height="300"></canvas>
            </div>
            <div class="chart">
                <h3>Top 10 Categorias</h3>
                <canvas id="categoria-chart" width="400" height="300"></canvas>
            </div>
            <div class="chart">
                <h3>Top 10 Trimestral</h3>
                <canvas id="views-august-chart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <!-- Se√ß√£o de An√°lise de Desertos de M√≠dia -->
        <div class="desertos-section" id="desertos-section">
            <div class="desertos-header">
                <h2>üèúÔ∏è An√°lise de Desertos de M√≠dia</h2>
            </div>
            
            <div class="desertos-stats" id="desertos-stats">
                <div class="deserto-stat">
                    <h4 id="desertos-count">-</h4>
                    <p>Desertos de M√≠dia<br><small>(sem ve√≠culos)</small></p>
                </div>
                <div class="deserto-stat critica">
                    <h4 id="criticos-count">-</h4>
                    <p>Cobertura Cr√≠tica<br><small>(1 ve√≠culo)</small></p>
                </div>
                <div class="deserto-stat adequada">
                    <h4 id="adequados-count">-</h4>
                    <p>Cobertura Adequada<br><small>(2+ ve√≠culos)</small></p>
                </div>
                <div class="deserto-stat">
                    <h4 id="percentual-desertos">-</h4>
                    <p>% de Desertos<br><small>do total de munic√≠pios</small></p>
                </div>
            </div>
            
            <div class="desertos-charts">
                <div class="deserto-chart">
                    <h4>üö® Munic√≠pios Priorit√°rios (Desertos)</h4>
                    <div class="municipios-list" id="desertos-list">
                        <div class="loading">Analisando dados...</div>
                    </div>
                    <button class="toggle-button" onclick="toggleDesertosCompletos()">Ver Lista Completa</button>
                </div>
                
                <div class="deserto-chart">
                    <h4>‚ö†Ô∏è Cobertura Cr√≠tica (1 ve√≠culo)</h4>
                    <div class="municipios-list" id="criticos-list">
                        <div class="loading">Analisando dados...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h3>Dados Detalhados</h3>
            <div id="data-table">
                <div class="loading">Carregando tabela...</div>
            </div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        
        // Carregar dados
        function loadData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    allData = data;
                    filteredData = [...allData];
                    
                    // Detectar fonte dos dados baseado na resposta
                    if (data.length > 0) {
                        // Verificar se os dados vieram do Google Sheets (tentativa de detec√ß√£o)
                        fetch('/api/refresh')
                            .then(response => response.json())
                            .then(result => {
                                if (result.status === 'success') {
                                    updateDataSourceIndicator('google-sheets', `Google Sheets (${data.length} registros)`);
                                } else {
                                    updateDataSourceIndicator('local-file', `Arquivo local (${data.length} registros)`);
                                }
                            })
                            .catch(() => {
                                updateDataSourceIndicator('local-file', `Arquivo local (${data.length} registros)`);
                            });
                    } else {
                        updateDataSourceIndicator('local-file', 'Nenhum dado encontrado');
                    }
                    
                    populateFilters();
                    updateDashboard();
                    updateDesertosAnalysis(); // Nova fun√ß√£o para an√°lise de desertos
                })
                .catch(error => {
                    console.error('Erro ao carregar dados:', error);
                });
        }
        
        function populateFilters() {
            console.log('Populando filtros...');
            
            // Cidades v√°lidas de Alagoas (lista oficial)
            const cidadesAlagoas = [
                '√Ågua Branca', 'Anadia', 'Arapiraca', 'Atalaia', 'Barra de Santo Ant√¥nio', 
                'Barra de S√£o Miguel', 'Batalha', 'Bel√©m', 'Belo Monte', 'Boca da Mata',
                'Branquinha', 'Cacimbinhas', 'Cajueiro', 'Campestre', 'Campo Alegre',
                'Campo Grande', 'Canapi', 'Capela', 'Carneiros', 'Ch√£ Preta',
                'Coit√© do N√≥ia', 'Col√¥nia Leopoldina', 'Coqueiro Seco', 'Coruripe', 'Cra√≠bas',
                'Delmiro Gouveia', 'Dois Riachos', 'Estrela de Alagoas', 'Feira Grande', 'Feliz Deserto',
                'Flexeiras', 'Girau do Ponciano', 'Ibateguara', 'Igaci', 'Igreja Nova',
                'Inhapi', 'Jacar√© dos Homens', 'Jacu√≠pe', 'Japaratinga', 'Jaramataia',
                'Jequi√° da Praia', 'Joaquim Gomes', 'Jundi√°', 'Junqueiro', 'Lagoa da Canoa',
                'Limoeiro de Anadia', 'Macei√≥', 'Major Isidoro', 'Mar Vermelho', 'Maragogi',
                'Maravilha', 'Marechal Deodoro', 'Mata Grande', 'Matriz de Camaragibe', 'Messias',
                'Minador do Negr√£o', 'Monteir√≥polis', 'Murici', 'Novo Lino', 'Olho d\'√Ågua das Flores',
                'Olho d\'√Ågua do Casado', 'Oliven√ßa', 'Ouro Branco', 'Palestina', 'Palmeira dos √çndios',
                'P√£o de A√ß√∫car', 'Pariconha', 'Paripueira', 'Passo de Camaragibe', 'Paulo Jacinto',
                'Penedo', 'Pia√ßabu√ßu', 'Pilar', 'Pindoba', 'Piranhas', 'Po√ßo das Trincheiras',
                'Porto Calvo', 'Porto de Pedras', 'Porto Real do Col√©gio', 'Quebrangulo', 'Rio Largo',
                'Roteiro', 'Santa Luzia do Norte', 'Santana do Ipanema', 'Santana do Munda√∫', 'S√£o Br√°s',
                'S√£o Jos√© da Laje', 'S√£o Jos√© da Tapera', 'S√£o Lu√≠s do Quitunde', 'S√£o Miguel dos Campos',
                'S√£o Miguel dos Milagres', 'S√£o Sebasti√£o', 'Satuba', 'Senador Rui Palmeira', 'Tanque d\'Arca',
                'Taquarana', 'Teot√¥nio Vilela', 'Traipu', 'Uni√£o dos Palmares', 'Vi√ßosa'
            ];
            
            // Filtrar cidades dos dados que est√£o na lista oficial de Alagoas
            const cidadesRaw = allData
                .map(item => item.Cidade)
                .filter(c => c && c.trim() !== '' && c !== 'N/A' && c !== 'null' && c !== 'undefined')
                .map(c => c.trim())
                .filter(c => cidadesAlagoas.includes(c)); // Filtrar apenas cidades de Alagoas
            
            const cidades = [...new Set(cidadesRaw)].sort();
            console.log('Cidades √∫nicas encontradas:', cidades);
            
            // Status com trim para remover espa√ßos
            const statusRaw = allData
                .map(item => item.Status)
                .filter(s => s && s.trim() !== '' && s !== 'N/A' && s !== 'null' && s !== 'undefined')
                .map(s => s.trim()); // Remover espa√ßos em branco no in√≠cio e fim
            
            const status = [...new Set(statusRaw)].sort();
            console.log('Status √∫nicos encontrados:', status);
            
            // Categorias
            const categoriasRaw = allData
                .map(item => item.Categoria)
                .filter(c => c && c.trim() !== '' && c !== 'N/A' && c !== 'null' && c !== 'undefined')
                .map(c => c.trim());
            
            const categorias = [...new Set(categoriasRaw)].sort();
            console.log('Categorias √∫nicas encontradas:', categorias);
            
            // Popular selects
            populateSelect('cidade-filter', cidades);
            populateSelect('status-filter', status);
            populateSelect('categoria-filter', categorias);
        }
        
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            
            // Salvar o texto da primeira op√ß√£o padr√£o
            const defaultText = select.children[0] ? select.children[0].textContent : 'Todas';
            const defaultValue = 'all';
            
            // Limpar completamente todas as op√ß√µes
            select.innerHTML = '';
            
            // Recriar a op√ß√£o padr√£o
            const defaultOption = document.createElement('option');
            defaultOption.value = defaultValue;
            defaultOption.textContent = defaultText;
            select.appendChild(defaultOption);
            
            // Garantir que options √© um array e remover duplicatas
            const cleanOptions = Array.isArray(options) ? options : [];
            const uniqueOptions = [...new Set(cleanOptions)].sort();
            
            // Adicionar novas op√ß√µes √∫nicas
            uniqueOptions.forEach(option => {
                if (option && 
                    option.toString().trim() !== '' && 
                    option !== 'N/A' && 
                    option !== 'null' && 
                    option !== 'undefined' &&
                    option !== null &&
                    option !== undefined) {
                    
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                }
            });
        }
        
        // Atualizar dashboard
        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTable();
        }
        
        // Atualizar KPIs
        function updateKPIs() {
            const total = filteredData.length;
            const aprovados = filteredData.filter(item => item.Status === 'APROVADO').length;
            const reprovados = filteredData.filter(item => item.Status === 'REPROVADO').length;
            const cidades = new Set(filteredData.map(item => item.Cidade).filter(c => c)).size;
            
            document.getElementById('kpis').innerHTML = `
                <div class="kpi">
                    <h3 style="color: #3498db;">${total}</h3>
                    <p>Total de Ve√≠culos</p>
                </div>
                <div class="kpi">
                    <h3 style="color: #27ae60;">${aprovados}</h3>
                    <p>Aprovados</p>
                </div>
                <div class="kpi">
                    <h3 style="color: #e74c3c;">${reprovados}</h3>
                    <p>Reprovados</p>
                </div>
                <div class="kpi">
                    <h3 style="color: #f39c12;">${cidades}</h3>
                    <p>Cidades</p>
                </div>
            `;
        }
        
        // Atualizar gr√°ficos (vers√£o simplificada)
        function updateCharts() {
            // Status chart
            const statusCount = {};
            filteredData.forEach(item => {
                const status = item.Status || 'N/A';
                statusCount[status] = (statusCount[status] || 0) + 1;
            });
            drawBarChart('status-chart', statusCount, 'Distribui√ß√£o por Status');
            
            // Cidade chart
            const cidadeCount = {};
            filteredData.forEach(item => {
                const cidade = item.Cidade || 'N/A';
                if (cidade !== 'N/A') {
                    cidadeCount[cidade] = (cidadeCount[cidade] || 0) + 1;
                }
            });
            const topCidades = Object.entries(cidadeCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {});
            drawBarChart('cidade-chart', topCidades, 'Top 10 Cidades');
            
            // Categoria chart
            const categoriaCount = {};
            filteredData.forEach(item => {
                const categoria = item.Categoria || 'N/A';
                if (categoria !== 'N/A') {
                    categoriaCount[categoria] = (categoriaCount[categoria] || 0) + 1;
                }
            });
            const topCategorias = Object.entries(categoriaCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {});
            drawBarChart('categoria-chart', topCategorias, 'Top 10 Categorias');
            
            // Top 10 Trimestral
            loadTopViewsTrimestral();
        }
        
        // Carregar Top 10 visualiza√ß√µes trimestrais
        async function loadTopViewsTrimestral() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                // Filtrar e ordenar por M√©dia Trimestral
                const validData = data
                    .filter(item => {
                        const media = item['M√©dia Trimestral'];
                        return media && media !== 'N/A' && !isNaN(media) && media > 0;
                    })
                    .sort((a, b) => {
                        const mediaA = parseFloat(a['M√©dia Trimestral']) || 0;
                        const mediaB = parseFloat(b['M√©dia Trimestral']) || 0;
                        return mediaB - mediaA;
                    })
                    .slice(0, 10);
                
                const viewsData = {};
                validData.forEach(item => {
                    const nome = item['Nome do ve√≠culo'];
                    const nomeShort = nome.length > 15 ? nome.substring(0, 15) + '...' : nome;
                    viewsData[nomeShort] = parseFloat(item['M√©dia Trimestral']) || 0;
                });
                
                drawBarChart('views-august-chart', viewsData, 'Top 10 Trimestral');
            } catch (error) {
                console.error('Erro ao carregar top visualiza√ß√µes trimestrais:', error);
            }
        }
        
        // Desenhar gr√°fico de barras simples
        function drawBarChart(canvasId, data, title) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Limpar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const entries = Object.entries(data);
            if (entries.length === 0) return;
            
            const maxValue = Math.max(...entries.map(([,value]) => value));
            const barWidth = Math.max(40, (canvas.width - 40) / entries.length - 15); // Largura m√≠nima de 40px
            const maxBarHeight = canvas.height - 120; // Ainda mais espa√ßo para labels
            
            entries.forEach(([label, value], index) => {
                const barHeight = (value / maxValue) * maxBarHeight;
                const x = index * (barWidth + 15) + 20; // Espa√ßamento consistente
                const y = canvas.height - barHeight - 90; // Muito mais espa√ßo para labels
                
                // Desenhar barra
                ctx.fillStyle = `hsl(${index * 360 / entries.length}, 70%, 50%)`;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Desenhar valor ACIMA da barra com muito mais espa√ßo
                ctx.fillStyle = '#333';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center';
                const formattedValue = value.toLocaleString();
                ctx.fillText(formattedValue, x + barWidth/2, y - 25); // Muito mais espa√ßo acima
                
                // Desenhar label (nome do ve√≠culo) - horizontal com quebra de linha se necess√°rio
                const truncatedLabel = label.length > 12 ? label.substring(0, 12) + '...' : label;
                ctx.fillStyle = '#555';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                
                // Posicionar label bem embaixo
                const labelY = canvas.height - 15;
                ctx.fillText(truncatedLabel, x + barWidth/2, labelY);
            });
        }
        
        // Atualizar tabela
        function updateTable() {
            const tableData = filteredData.slice(0, 150); // Mostrar at√© 150 registros
            
            let tableHTML = '<table><thead><tr>';
            const columns = [
                'Nome do ve√≠culo', 
                'Cidade', 
                'Status',
                'Categoria',
                'Cookies',
                'Expediente',
                'Endere√ßo',
                'M√©dia Trimestral',
                'Analytics'
            ];
            columns.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            tableData.forEach(item => {
                const status = item['Status'] || 'N/A';
                const isReprovado = status === 'REPROVADO';
                const rowClass = isReprovado ? ' class="reprovado"' : '';
                
                tableHTML += `<tr${rowClass}>`;
                columns.forEach(col => {
                    let value = item[col] || 'N/A';
                    let displayValue = value;
                    
                    // Formata√ß√£o especial para valores num√©ricos das views e m√©dia
                    if ((col.includes('Views') || col.includes('Total de') || col.includes('M√©dia')) && value !== 'N/A' && value !== 'N√£o tem analytics' && !isNaN(value)) {
                        displayValue = parseInt(value).toLocaleString();
                    }
                    
                    // Truncar textos muito longos e adicionar tooltip
                    if (typeof displayValue === 'string' && displayValue.length > 30) {
                        const truncated = displayValue.substring(0, 30) + '...';
                        tableHTML += `<td title="${displayValue}" style="cursor: help;">${truncated}</td>`;
                    } else {
                        tableHTML += `<td>${displayValue}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('data-table').innerHTML = tableHTML;
        }
        
        // Event listeners para filtros
        document.getElementById('cidade-filter').addEventListener('change', applyFilters);
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('categoria-filter').addEventListener('change', applyFilters);
        
        // Event listener para busca
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300); // Debounce de 300ms
        });
        
        // Fun√ß√£o de busca
        async function performSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            
            if (query.length === 0) {
                // Se n√£o h√° busca, mostrar todos os dados filtrados
                filteredData = allData.filter(item => {
                    const cidadeFilter = document.getElementById('cidade-filter').value;
                    const statusFilter = document.getElementById('status-filter').value;
                    const categoriaFilter = document.getElementById('categoria-filter').value;
                    
                    return (cidadeFilter === 'all' || item.Cidade === cidadeFilter) &&
                           (statusFilter === 'all' || item.Status === statusFilter) &&
                           (categoriaFilter === 'all' || item.Categoria === categoriaFilter);
                });
            } else {
                // Busca local nos dados
                const cidadeFilter = document.getElementById('cidade-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const categoriaFilter = document.getElementById('categoria-filter').value;
                
                filteredData = allData.filter(item => {
                    // Verificar se o nome do ve√≠culo cont√©m a busca
                    const nomeVeiculo = (item['Nome do ve√≠culo'] || '').toLowerCase();
                    const matchesSearch = nomeVeiculo.includes(query);
                    
                    // Aplicar filtros
                    const matchesFilters = (cidadeFilter === 'all' || item.Cidade === cidadeFilter) &&
                                         (statusFilter === 'all' || item.Status === statusFilter) &&
                                         (categoriaFilter === 'all' || item.Categoria === categoriaFilter);
                    
                    return matchesSearch && matchesFilters;
                });
            }
            
            updateDashboard();
        }
        
        function applyFilters() {
            // Limpar campo de busca quando usar filtros
            document.getElementById('search-input').value = '';
            
            const cidadeFilter = document.getElementById('cidade-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const categoriaFilter = document.getElementById('categoria-filter').value;
            
            filteredData = allData.filter(item => {
                return (cidadeFilter === 'all' || item.Cidade === cidadeFilter) &&
                       (statusFilter === 'all' || item.Status === statusFilter) &&
                       (categoriaFilter === 'all' || item.Categoria === categoriaFilter);
            });
            
            updateDashboard();
        }
        
        // === AN√ÅLISE DE DESERTOS DE M√çDIA ===
        
        // Lista completa dos 102 munic√≠pios de Alagoas
        const municipiosAlagoas = [
            "√Ågua Branca", "Anadia", "Arapiraca", "Atalaia", "Barra de Santo Ant√¥nio",
            "Barra de S√£o Miguel", "Batalha", "Bel√©m", "Belo Monte", "Boca da Mata",
            "Branquinha", "Cacimbinhas", "Cajueiro", "Campestre", "Campo Alegre",
            "Campo Grande", "Canapi", "Capela", "Carneiros", "Ch√£ Preta",
            "Coit√© do Noia", "Col√¥nia Leopoldina", "Coqueiro Seco", "Coruripe", "Cra√≠bas",
            "Delmiro Gouveia", "Dois Riachos", "Estrela de Alagoas", "Feira Grande", "Feliz Deserto",
            "Flexeiras", "Girau do Ponciano", "Ibateguara", "Igaci", "Igreja Nova",
            "Inhapi", "Jacar√© dos Homens", "Jacu√≠pe", "Japaratinga", "Jaramataia",
            "Jequi√° da Praia", "Joaquim Gomes", "Jundi√°", "Junqueiro", "Lagoa da Canoa",
            "Limoeiro de Anadia", "Macei√≥", "Major Izidoro", "Mar Vermelho", "Maragogi",
            "Maravilha", "Marechal Deodoro", "Maribondo", "Mata Grande", "Matriz de Camaragibe",
            "Messias", "Minador do Negr√£o", "Monteir√≥polis", "Murici", "Novo Lino",
            "Olho d'√Ågua das Flores", "Olho d'√Ågua do Casado", "Olho d'√Ågua Grande", "Oliven√ßa", "Ouro Branco",
            "Palestina", "Palmeira dos √çndios", "P√£o de A√ß√∫car", "Pariconha", "Paripueira",
            "Passo de Camaragibe", "Paulo Jacinto", "Penedo", "Pia√ßabu√ßu", "Pilar",
            "Pindoba", "Piranhas", "Po√ßo das Trincheiras", "Porto Calvo", "Porto de Pedras",
            "Porto Real do Col√©gio", "Quebrangulo", "Rio Largo", "Roteiro", "Santa Luzia do Norte",
            "Santana do Ipanema", "Santana do Munda√∫", "S√£o Br√°s", "S√£o Jos√© da Laje", "S√£o Jos√© da Tapera",
            "S√£o Lu√≠s do Quitunde", "S√£o Miguel dos Campos", "S√£o Miguel dos Milagres", "S√£o Sebasti√£o", "Satuba",
            "Senador Rui Palmeira", "Tanque d'Arca", "Taquarana", "Teot√¥nio Vilela", "Traipu",
            "Uni√£o dos Palmares", "Vi√ßosa"
        ];
        
        let mostrandoDesertosCompletos = false;
        
        function updateDesertosAnalysis() {
            console.log('=== INICIANDO AN√ÅLISE DE DESERTOS DE M√çDIA ===');
            console.log('Total de dados carregados:', allData.length);
            console.log('Primeiros 3 registros:', allData.slice(0, 3));
            
            // Contar ve√≠culos por cidade (apenas cidades de Alagoas)
            const cidadeCount = {};
            allData.forEach(item => {
                if (item.Cidade && item.Cidade.trim() !== '' && item.Cidade !== 'N/A') {
                    const cidade = item.Cidade.trim();
                    // S√≥ contar se for munic√≠pio de Alagoas
                    if (municipiosAlagoas.includes(cidade)) {
                        cidadeCount[cidade] = (cidadeCount[cidade] || 0) + 1;
                    }
                }
            });
            
            console.log('Cidades com ve√≠culos encontradas:', Object.keys(cidadeCount).length);
            console.log('Detalhes das cidades:', cidadeCount);
            
            // Identificar categorias
            const desertos = [];
            const criticos = [];
            const adequados = [];
            
            municipiosAlagoas.forEach(municipio => {
                const count = cidadeCount[municipio] || 0;
                if (count === 0) {
                    desertos.push(municipio);
                } else if (count === 1) {
                    criticos.push({nome: municipio, count: count});
                } else {
                    adequados.push({nome: municipio, count: count});
                }
            });
            
            console.log('RESULTADOS DA AN√ÅLISE:');
            console.log('- Desertos de m√≠dia:', desertos.length);
            console.log('- Cobertura cr√≠tica:', criticos.length);
            console.log('- Cobertura adequada:', adequados.length);
            
            // Atualizar estat√≠sticas
            const totalMunicipios = municipiosAlagoas.length;
            const percentualDesertos = ((desertos.length / totalMunicipios) * 100).toFixed(1);
            
            console.log('Atualizando elementos DOM...');
            
            const desertosElement = document.getElementById('desertos-count');
            const criticosElement = document.getElementById('criticos-count');
            const adequadosElement = document.getElementById('adequados-count');
            const percentualElement = document.getElementById('percentual-desertos');
            
            console.log('Elementos encontrados:', {
                desertos: !!desertosElement,
                criticos: !!criticosElement,
                adequados: !!adequadosElement,
                percentual: !!percentualElement
            });
            
            if (desertosElement) desertosElement.textContent = desertos.length;
            if (criticosElement) criticosElement.textContent = criticos.length;
            if (adequadosElement) adequadosElement.textContent = adequados.length;
            if (percentualElement) percentualElement.textContent = percentualDesertos + '%';
            
            // Atualizar listas
            updateDesertosLists(desertos, criticos);
            
            console.log('=== AN√ÅLISE DE DESERTOS CONCLU√çDA ===');
        }
        
        function updateDesertosLists(desertos, criticos) {
            // Lista de desertos (mostra apenas os 10 primeiros inicialmente)
            const desertosContainer = document.getElementById('desertos-list');
            const desertosParaMostrar = mostrandoDesertosCompletos ? desertos : desertos.slice(0, 10);
            
            if (desertos.length === 0) {
                desertosContainer.innerHTML = '<div style="text-align: center; color: #27ae60; font-weight: bold;">üéâ Nenhum deserto de m√≠dia!</div>';
            } else {
                desertosContainer.innerHTML = desertosParaMostrar.map(municipio => 
                    `<div class="municipio-item">${municipio}</div>`
                ).join('');
                
                if (!mostrandoDesertosCompletos && desertos.length > 10) {
                    desertosContainer.innerHTML += `<div style="text-align: center; margin-top: 10px; color: #666; font-style: italic;">... e mais ${desertos.length - 10} munic√≠pios</div>`;
                }
            }
            
            // Lista de cr√≠ticos
            const criticosContainer = document.getElementById('criticos-list');
            if (criticos.length === 0) {
                criticosContainer.innerHTML = '<div style="text-align: center; color: #27ae60; font-weight: bold;">üéâ Nenhuma cobertura cr√≠tica!</div>';
            } else {
                criticosContainer.innerHTML = criticos.map(item => 
                    `<div class="municipio-item critico">${item.nome} <small>(${item.count} ve√≠culo)</small></div>`
                ).join('');
            }
        }
        
        function toggleDesertosCompletos() {
            mostrandoDesertosCompletos = !mostrandoDesertosCompletos;
            const button = document.querySelector('.toggle-button');
            button.textContent = mostrandoDesertosCompletos ? 'Ver Resumo' : 'Ver Lista Completa';
            
            // Re-executar an√°lise para atualizar as listas
            updateDesertosAnalysis();
        }
        
        // Carregar dados inicialmente
        loadData();
        
        // Fun√ß√£o para gerar PDF
        function generatePDF() {
            // Mostrar loading
            const originalButton = document.querySelector('.pdf-button');
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '‚è≥ Gerando PDF...';
            originalButton.disabled = true;
            
            // Configura√ß√µes do PDF
            const opt = {
                margin: 1,
                filename: 'dashboard-veiculos-comunicacao.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };
            
            // Gerar PDF
            html2pdf().set(opt).from(document.querySelector('.container')).save().then(() => {
                // Restaurar bot√£o
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            }).catch((error) => {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Tente novamente.');
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            });
        }
        
        // Fun√ß√£o para atualizar dados do Google Sheets
        function refreshData() {
            const refreshButton = document.querySelector('.refresh-button');
            const originalText = refreshButton.innerHTML;
            
            // Mostrar loading
            refreshButton.innerHTML = '‚è≥ Atualizando...';
            refreshButton.disabled = true;
            
            // Fazer requisi√ß√£o para atualizar dados
            fetch('/api/refresh')
                .then(response => response.json())
                .then(result => {
                    if (result.success === true) {
                        // Recarregar dados e atualizar dashboard
                        loadData();
                        updateDataSourceIndicator('google-sheets', `${result.source} (${result.total_records} registros)`);
                        alert(result.message);
                    } else {
                        updateDataSourceIndicator('local-file', 'Arquivo local (Google Sheets indispon√≠vel)');
                        alert('Erro ao atualizar: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao atualizar dados:', error);
                    updateDataSourceIndicator('local-file', 'Arquivo local (erro de conex√£o)');
                    alert('Erro ao conectar com o servidor');
                })
                .finally(() => {
                    // Restaurar bot√£o
                    refreshButton.innerHTML = originalText;
                    refreshButton.disabled = false;
                });
        }
        
        // Fun√ß√£o para atualizar indicador de fonte dos dados
        function updateDataSourceIndicator(source, text) {
            const indicator = document.getElementById('data-source');
            const textElement = document.getElementById('data-source-text');
            
            // Remover classes existentes
            indicator.classList.remove('google-sheets', 'local-file');
            
            // Adicionar classe apropriada
            indicator.classList.add(source);
            
            // Atualizar texto com link
            const sheetsUrl = 'https://docs.google.com/spreadsheets/d/17TnGB6NpsziDec4fPH-d0TCQwk2LN0BAv6yjmIpyZnI/edit?gid=1225239898#gid=1225239898';
            
            if (source === 'google-sheets') {
                textElement.innerHTML = `üåê Fonte: <a href="${sheetsUrl}" target="_blank" style="color: #27ae60; text-decoration: underline;">${text}</a> (Atualizado em tempo real)`;
            } else {
                textElement.innerHTML = `üìÅ Fonte: <a href="${sheetsUrl}" target="_blank" style="color: #f39c12; text-decoration: underline;">Google Sheets</a> (${text})`;
            }
        }
    </script>
    
    <script>
        // Carregar dados quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>
